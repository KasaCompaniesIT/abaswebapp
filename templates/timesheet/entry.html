{% extends 'base.html' %}
{% block nav_timesheet %}active{% endblock %}
{% block header %}
<div class="navbar-brand navbar-text">{% block title %}Timesheet Entry{% endblock %}</div>
{% endblock %}
{% block subheader %}
<nav aria-label="breadcrumb" class="breadcrumb-bg">
    <div class="d-flex justify-content-between align-items-center">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('timesheet.index') }}">Timesheet</a></li>
            <li class="breadcrumb-item active" aria-current="page">Entry</li>
        </ol>
        {% if g.user %}
        <span class="text-muted pr-2">{{ g.user.EmpName.title() }}</span>
        {% endif %}
    </div>
</nav>
<p></p>
{% endblock %}
{% block content %}


<div class="container-fluid">
    <!-- User Lookup Form -->
    <form method="post" class="abasid-lookup">
        <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="inputGroup-sizing-default">Abas User ID</span>
            </div>
            <input type="text" class="form-control" name="abas_ID" id="abas_ID" aria-label="Abas User ID Input" aria-describedby="inputGroup-sizing-default" value="{{ abasID if abasID else g.user.EmpID }}">
            <div class="input-group-append">
                <button class="btn btn-abas" type="submit" name="button" id="btn-abasid" value="btn-abasid">Lookup</button>
              </div>
          </div>

    <!-- </form>  -->
    <!-- 
    {{ abasUser}}
    ID = 0
    Emp = 1
    EmpName = 2
    Dept = 3
    Supervisor = 4
    Wagegroup = 5
    SupervisorName = 6 
    -->

    <!-- Info Panel -->
    {% if abasUser %}
    <div class="info-panel card mb-4 border-dark">
        <div class="card-header bg-abas-info text-white">
            User Information
        </div>
        <div class="card-body compact-info-panel">
            <p><strong>Abas ID:</strong> {{ abasUser.EmpID }} | {{ abasUser.Emp }}</p>
            <p><strong>Name:</strong> {{ abasUser.EmpName }}</p>
            <p><strong>Supervisor:</strong> {{ abasUser.SupervisorName }}</p>
            <!-- Floating Badge -->
            <h5 id="floatingBadge">
                <span class="badge badge-abas" id="totalHoursBadge">0</span>
            </h5>
        </div>
    </div>

    <!-- <form method="post"> -->
        <div class="input-group">
            <div class="input-group-prepend">
                <button class="btn btn-abas" type="submit" name="button" id="btnPrev" value="btnPrev">
                    <i class="fas fa-chevron-left"></i> <!-- Font Awesome left arrow icon -->
                </button>
            </div>
            <input type="hidden" name="startDate" id="startDateInput" value="{{ startOfPrevWeek }}">
            <input type="hidden" name="endDate" id="endDateInput" value="{{ endOfPrevWeek }}">
            <input id="startDate" type="text" class="form-control text-center" placeholder="" aria-label="" aria-describedby="btnPrev" value="{{ startOfPrevWeek }}" disabled>
            <input id="endDate" type="text" class="form-control text-center" placeholder="" aria-label="" aria-describedby="btnNext" value="{{ endOfPrevWeek }}" disabled>
            <div class="input-group-append">
                <button class="btn btn-abas" type="submit" name="button" id="btnNext" value="btnNext">
                    <i class="fas fa-chevron-right"></i> <!-- Font Awesome right arrow icon -->
                </button>
                <button class="btn btn-abas" type="submit" name="button" id="btnToday" value="btnToday">
                    Today
                </button>
            </div>
        </div>
        <p></p>
    </form>

    <!-- Timecard Section -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4 px-2" id="timecard">
        <!-- Card 1 -->
        {% set nswk = namespace(total_hours=0) %} <!-- Create a mutable namespace object -->
        {% for day in dateRangePrevWeek %}
        <div id="card_{{ day.date.replace('/', '_') }}" class="col my-2 px-2">
            <div class="card bg-light border-dark card-shadow">
                <div class="card-header text-center 
                    {% if day.date == today %}
                        bg-abas
                    {% elif day.isHoliday %}
                        bg-warning
                    {% elif day.date | dateformat('%A') in ['Saturday', 'Sunday'] %}
                        bg-secondary text-light                    
                    {% else %}
                        bg-dark2 text-light
                    {% endif %}
                ">
                    {{ day.date | dateformat("%A") }} - {{ day.date }}
                </div>
                <div class="card-body compact-card">
                    {% set ns = namespace(total_hours=0) %} <!-- Create a mutable namespace object -->
                    {% if timecard_data[day.date] %}
                        {% for t in timecard_data[day.date] %}
                        <div class="d-flex justify-content-between align-items-center time-entry">
                            <p>{{ t.WSNumber }} {{ t.OpNameExtended }}</p>
                            <h5>
                                <span class="badge badge-secondary">{{ t.tHoursWorked }}</span>
                            </h5>
                            {% if t.TimeEntryID %}
                            <button class="btn btn-danger btn-sm delete-entry-btn" data-timeentryid="{{ t.TimeEntryID }}" title="Delete Entry">
                                <i class="fas fa-times"></i>
                            </button>
                            {% endif %}
                        </div>
                        {% set ns.total_hours = ns.total_hours + t.tHoursWorked %} <!-- Accumulate the total -->
                        {% endfor %}
                    {% else %}
                        {% if day.isHoliday %}
                            <div class="d-flex justify-content-between">
                                <p class="font-italic">Holiday Hours</p>
                                <h5><span class="badge badge-secondary font-italic">8.00</span></h5>
                                {% set ns.total_hours = ns.total_hours + 8.00 %} <!-- Accumulate the total -->
                            </div>
                        {% else %}
                            <p>No data available for this date.</p>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="card-footer compact-card-footer text-right">
                    <small>Total Hours: <span class="font-weight-bold">{{ ns.total_hours }}</span></small> <!-- Display the total hours -->
                </div>
            </div>
        </div>
        {% set nswk.total_hours = nswk.total_hours|float + ns.total_hours|float %}
        {% endfor %}
    </div>

    <button id="addTimeButton" class="btn btn-abas btn-floating" title="Add Time" 
        {% if not can_add_or_finalize %} disabled {% endif %}
        {% if week_finalized %} disabled {% endif %}>
        <i class="fas fa-plus"></i>
    </button>

    <button id="finalizeTimeButton" class="btn btn-abas btn-floating2" title="Finalize Payroll Time" 
        {% if not can_add_or_finalize %} disabled {% endif %}
        {% if week_finalized %} disabled {% endif %}>
        <i class="fas fa-check"></i>
    </button>

    <!-- Add Time Modal -->
    <div class="modal fade" id="addTimeModal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="addTimeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark-custom">
                    <h5 class="modal-title" id="addTimeModalLabel">Time Entry</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="dateForm" method="post" action="{{ url_for('timesheet.save_entry') }}">
                        <input type="hidden" id="selectedDateInput" name="selectedDate">
                        <input type="hidden" id="abasIDInput" name="abasID" value="{{ abasUser.EmpID }}">
                        <input type="hidden" id="workSlipIDInput" name="workSlipID">
                        <!-- Grid of Dates -->
                        <div class="container">
                            <div class="row text-center">
                                {% for day in dateRangePrevWeek %}
                                <div class="col date-card-col">
                                    <div class="date-card p-2 border rounded select-date-card 
                                        {% if day.date == today %} bg-success text-white 
                                        {% elif day.date | dateformat('%A') in ['Saturday', 'Sunday'] %} bg-light-grey 
                                        {% endif %}" 
                                        data-date="{{ day.date }}" 
                                        data-selected="{% if day.date == today %}true{% else %}false{% endif %}">
                                        <div class="day-of-week font-weight-bold">{{ day.date | dateformat('%a') }}</div>
                                        <div class="date-value">{{ day.date | dateformat('%d') }}</div> <!-- Display only the day number -->
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="row text-center mt-2" id="selProject">
                                <div class="col">
                                    <select id="projectDropdown" class="form-control selectpicker" data-live-search="true" title="Select a Project" required>
                                        <!-- Options will be dynamically populated -->
                                    </select>
                                </div>
                            </div>
                            <div class="row text-center mt-2" id="selWorkOrder">
                                <div class="col">
                                    <select id="workOrderDropdown" class="form-control selectpicker" data-live-search="true" title="Select a Work Order" style="display: none;" required>
                                        <!-- Options will be dynamically populated -->
                                    </select>
                                </div>
                            </div>
                            <div class="row text-center mt-2" id="selWorkSlip">
                                <div class="col">
                                    <select id="workSlipDropdown" class="form-control selectpicker" data-live-search="true" title="Select an Operation" style="display: none;" required>
                                        <!-- Options will be dynamically populated -->
                                    </select>
                                </div>
                            </div>
                            <div class="row text-center mt-2">
                                <div class="col">
                                    <div class="d-flex justify-content-center">
                                        <div class="input-group mb-3">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text" id="hoursLabel">Hours Worked</span>
                                            </div>
                                            <input type="text" class="form-control" name="hoursWorked" id="hoursWorked" placeholder="Hours Worked" aria-label="Hours Worked Input" aria-describedby="hoursLabel" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <p></p>
                            <div class="row text-right mt-2">
                                <div class="col col-button">
                                    <button type="submit" class="btn btn-abas" id="btnAddTime">Add to Timesheet</button>
                                </div>
                            </div>
                        </div>
                    </form> 
                </div>                           
            </div>
        </div>
    </div>

    <!-- Finalize Time Modal -->
    <div class="modal fade" id="finalizeTimeModal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="finalizeTimeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark-custom">
                    <h5 class="modal-title" id="finalizeTimeModalLabel">Finalize Payroll Time</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="finalizeTimeForm" method="post" action="{{ url_for('timesheet.finalize_time') }}">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="finalizeTimeTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Operation</th>
                                        <th>Paychex Code</th>
                                        <th>Hours</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Table rows will be dynamically populated here -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-right font-weight-bold">Total Hours:</td>
                                        <td class="font-weight-bold">
                                            <span id="finalizeTotalHoursBadge">10</span>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="text-right">
                            <button id="finalizeTimeModalButton" type="submit" class="btn btn-abas">Finalize</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
<p></p>
{% endblock %} <!-- end content block -->
{% block script %}
<script>

    
    function updateTotalHours() {
        let totalHours = 0;

        // Loop through all cards and sum up the total hours
        document.querySelectorAll('.card-body').forEach(cardBody => {
            cardBody.querySelectorAll('.time-entry .badge').forEach(badge => {
                const hours = parseFloat(badge.textContent);
                if (!isNaN(hours)) {
                    totalHours += hours;
                }
            });
        });

        // Update the floating badge with the total hours
        const totalHoursBadge = document.getElementById('totalHoursBadge');
        if (totalHoursBadge) {
            totalHoursBadge.textContent = totalHours.toFixed(2);
        }
    }

    // Call the function to update the total hours on page load
    document.addEventListener('DOMContentLoaded', function () {
        updateTotalHours();
    });

    document.getElementById('addTimeButton').addEventListener('click', function () {
        var addTimeModal = new bootstrap.Modal(document.getElementById('addTimeModal'));
        addTimeModal.show();

        // Fetch data from the server
        fetch('/timesheet/entry/getProjects')
            .then(response => response.json())
            .then(data => {
                const projectDropdown = document.getElementById('projectDropdown');
                const workOrderDropdown = document.getElementById('workOrderDropdown');
                const workSlipDropdown = document.getElementById('workSlipDropdown');
                projectDropdown.innerHTML = ''; // Clear existing options
                workOrderDropdown.innerHTML = ''; // Clear existing options
                workSlipDropdown.innerHTML = ''; // Clear existing options

                data.projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.number + " - " + project.desc;
                    projectDropdown.appendChild(option);
                });

                // Refresh the Bootstrap Select dropdown
                $('.selectpicker').selectpicker('refresh');
            })
            .catch(error => console.error('Error fetching projects:', error));
    });

    document.getElementById('finalizeTimeButton').addEventListener('click', function () {
        const finalizeTimeModal = new bootstrap.Modal(document.getElementById('finalizeTimeModal'));
        finalizeTimeModal.show();
    
        // Declare payrollPaychex_list inside the function
        const payrollPaychex_list = {{ paychex_list | tojson }};
        console.log("Paychex List:", payrollPaychex_list); // Debugging: Log the paychex_list
    
        // Fetch the latest time entries
        const abasID = document.getElementById('abasIDInput').value;
        const startDate = document.getElementById('startDateInput').value;
        const endDate = document.getElementById('endDateInput').value;
    
        const isSalary = {{ g.user.isHourly | tojson }} === false; // Check if the employee is salaried
        const salaryPlusStart = {{ g.user.SalaryPlusStart | tojson }};
    
        console.log("Is Salary:", isSalary); // Debugging: Log if the user is salaried
        console.log("Salary Plus Start:", salaryPlusStart); // Debugging: Log the salary plus start

        fetch(`/timesheet/entry/get_time_entries?abas_id=${abasID}&start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableBody = document.querySelector('#finalizeTimeModal tbody');
                    tableBody.innerHTML = ''; // Clear existing rows
                    const totalHoursBadge = document.getElementById('finalizeTotalHoursBadge');
                    totalHoursBadge.textContent = '0'; // Reset the total hours badge
                    let cumulativeHours = 0;
                    let totalHours = 0; // Initialize total hours variable
    
                    // Populate the table with the latest time entries
                    data.time_entries.forEach(entry => {
                        console.log("Processing Entry:", entry); // Debugging: Log each entry
                        console.log("Cumulative Hours Before:", cumulativeHours); // Debugging cumulative hours
    
                        let rowHTML = '';                        
    
                        if (isSalary) {
                            const entryHours = parseFloat(entry.tHoursWorked);
                            if (cumulativeHours + entryHours <= 40) {
                                // Entire entry fits within the first 40 hours
                                rowHTML = `
                                    <tr>
                                        <td>${entry.WorkDate}</td>
                                        <td>${entry.WSNumber} - ${entry.OpName}</td>
                                        <td>
                                            <select name="paychex_code_${entry.EntryID}" class="form-control">
                                                ${payrollPaychex_list.map(paychex => `
                                                    <option value="${paychex.id}" ${paychex.code === 'E1' ? 'selected' : ''}>
                                                        ${paychex.code} - ${paychex.description}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </td>
                                        <td>${entryHours.toFixed(2)}</td>
                                    </tr>
                                `;
                                totalHours += entryHours; // Add to total hours
                            } else if (cumulativeHours + entryHours > 40 && salaryPlusStart == 0) {
                                // Entry crosses the 40-hour mark but is within the salary plus threshold
                                const remainingHoursTo40 = Math.max(0, 40 - cumulativeHours); // Hours needed to reach 40
                                const hoursBeyond40 = entryHours - remainingHoursTo40; // Remaining hours beyond 40
                            
                                console.log("Remaining Hours to 40:", remainingHoursTo40); // Debugging
                                console.log("Hours Beyond 40:", hoursBeyond40); // Debugging
                            
                                // First row: Hours up to 40
                                if (remainingHoursTo40 > 0) {
                                    rowHTML = `
                                        <tr>
                                            <td>${entry.WorkDate}</td>
                                            <td>${entry.WSNumber} - ${entry.OpName}</td>
                                            <td>
                                                <select name="paychex_code_${entry.EntryID}_1" class="form-control">
                                                    ${payrollPaychex_list.map(paychex => `
                                                        <option value="${paychex.id}" ${paychex.code === 'E1' ? 'selected' : ''}>
                                                            ${paychex.code} - ${paychex.description}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </td>
                                            <td>${remainingHoursTo40.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                                totalHours += remainingHoursTo40; // Add to total hours
                            } else if (cumulativeHours + entryHours > 40 && salaryPlusStart > 0) {
                                // Entry crosses the 40-hour mark but is within the salary plus threshold
                                const remainingHoursTo40 = Math.max(0, 40 - cumulativeHours); // Hours needed to reach 40
                                const hoursBeyond40 = entryHours - remainingHoursTo40; // Remaining hours beyond 40
                            
                                console.log("Remaining Hours to 40:", remainingHoursTo40); // Debugging
                                console.log("Hours Beyond 40:", hoursBeyond40); // Debugging
                            
                                // First row: Hours up to 40
                                if (remainingHoursTo40 > 0) {
                                    rowHTML = `
                                        <tr>
                                            <td>${entry.WorkDate}</td>
                                            <td>${entry.WSNumber} - ${entry.OpName}</td>
                                            <td>
                                                <select name="paychex_code_${entry.EntryID}_1" class="form-control">
                                                    ${payrollPaychex_list.map(paychex => `
                                                        <option value="${paychex.id}" ${paychex.code === 'E1' ? 'selected' : ''}>
                                                            ${paychex.code} - ${paychex.description}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </td>
                                            <td>${remainingHoursTo40.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                            
                                // Second row: Hours beyond 40 with E50 code
                                if (hoursBeyond40 > 0) {
                                    console.log("Creating E50 row for hours:", hoursBeyond40); // Debugging
                                    rowHTML += `
                                        <tr>
                                            <td>${entry.WorkDate}</td>
                                            <td>${entry.WSNumber} - ${entry.OpName}</td>
                                            <td>
                                                <select name="paychex_code_${entry.EntryID}_2" class="form-control">
                                                    ${payrollPaychex_list.map(paychex => `
                                                        <option value="${paychex.id}" ${paychex.code === 'E50' ? 'selected' : ''}>
                                                            ${paychex.code} - ${paychex.description}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </td>
                                            <td>${hoursBeyond40.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                                totalHours += entryHours; // Add to total hours
                            } 
                            /* else if (cumulativeHours + entryHours > 40 && cumulativeHours + entryHours <= salaryPlusStart) {
                                // Entry crosses the 40-hour mark but is within the salary plus threshold
                                const remainingHoursTo40 = Math.max(0, 40 - cumulativeHours); // Hours needed to reach 40
                                const hoursBeyond40 = entryHours - remainingHoursTo40; // Remaining hours beyond 40
                            
                                console.log("Remaining Hours to 40:", remainingHoursTo40); // Debugging
                                console.log("Hours Beyond 40:", hoursBeyond40); // Debugging
                            
                                // First row: Hours up to 40
                                if (remainingHoursTo40 > 0) {
                                    rowHTML = `
                                        <tr>
                                            <td>${entry.WorkDate}</td>
                                            <td>${entry.WSNumber} - ${entry.OpName}</td>
                                            <td>
                                                <select name="paychex_code_${entry.EntryID}_1" class="form-control">
                                                    ${payrollPaychex_list.map(paychex => `
                                                        <option value="${paychex.id}" ${paychex.code === 'E1' ? 'selected' : ''}>
                                                            ${paychex.code} - ${paychex.description}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </td>
                                            <td>${remainingHoursTo40.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                            
                                // Second row: Hours beyond 40 with S40 code
                                if (hoursBeyond40 > 0) {
                                    console.log("Creating S40 row for hours:", hoursBeyond40); // Debugging
                                    rowHTML += `
                                        <tr>
                                            <td>${entry.WorkDate}</td>
                                            <td>${entry.WSNumber} - ${entry.OpName}</td>
                                            <td>
                                                <select name="paychex_code_${entry.EntryID}_2" class="form-control">
                                                    ${payrollPaychex_list.map(paychex => `
                                                        <option value="${paychex.id}" ${paychex.code === 'S40' ? 'selected' : ''}>
                                                            ${paychex.code} - ${paychex.description}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </td>
                                            <td>${hoursBeyond40.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                                totalHours += entryHours; // Add to total hours
                            } else if (cumulativeHours + entryHours > salaryPlusStart) {
                                // Entry exceeds the salary plus threshold
                                const remainingHoursToSalaryPlus = Math.max(0, salaryPlusStart - cumulativeHours); // Hours to reach salary plus
                                const overtimeHours = Math.max(0, entryHours - remainingHoursToSalaryPlus); // Remaining hours beyond salary plus
                                console.log("Salary Plus Start:", salaryPlusStart); // Debugging
                                console.log("Remaining Hours to Salary Plus:", remainingHoursToSalaryPlus); // Debugging
                                console.log("Overtime Hours:", overtimeHours); // Debugging
                            
                                // First row: Hours up to salary plus with S40 code
                                if (remainingHoursToSalaryPlus > 0) {
                                    rowHTML = `
                                        <tr>
                                            <td>${entry.WorkDate}</td>
                                            <td>${entry.WSNumber} - ${entry.OpName}</td>
                                            <td>
                                                <select name="paychex_code_${entry.EntryID}_1" class="form-control">
                                                    ${payrollPaychex_list.map(paychex => `
                                                        <option value="${paychex.id}" ${paychex.code === 'S40' ? 'selected' : ''}>
                                                            ${paychex.code} - ${paychex.description}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </td>
                                            <td>${remainingHoursToSalaryPlus.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                            
                                // Second row: Overtime hours beyond salary plus with E50 code
                                if (overtimeHours > 0) {
                                    rowHTML += `
                                        <tr>
                                            <td>${entry.WorkDate}</td>
                                            <td>${entry.WSNumber} - ${entry.OpName}</td>
                                            <td>
                                                <select name="paychex_code_${entry.EntryID}_2" class="form-control">
                                                    ${payrollPaychex_list.map(paychex => `
                                                        <option value="${paychex.id}" ${paychex.code === 'E50' ? 'selected' : ''}>
                                                            ${paychex.code} - ${paychex.description}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </td>
                                            <td>${overtimeHours.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                                totalHours += entryHours; // Add to total hours
                            } */
                        }
    
                        // For hourly employees
                        if (!isSalary) {
                            const entryHours = parseFloat(entry.tHoursWorked);

                            if (cumulativeHours + entryHours <= 40) {
                                // Entire entry fits within the first 40 hours
                                rowHTML = `
                                    <tr>
                                        <td>${entry.WorkDate}</td>
                                        <td>${entry.WSNumber} - ${entry.OpName}</td>
                                        <td>
                                            <select name="paychex_code_${entry.EntryID}" class="form-control">
                                                ${payrollPaychex_list.map(paychex => `
                                                    <option value="${paychex.id}" ${paychex.code === 'E1' ? 'selected' : ''}>
                                                        ${paychex.code} - ${paychex.description}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </td>
                                        <td>${entryHours.toFixed(2)}</td>
                                    </tr>
                                `;
                                totalHours += entryHours; // Add to total hours
                            } else if (cumulativeHours + entryHours > 40) {
                                // Entry crosses the 40-hour mark
                                const remainingHoursTo40 = Math.max(0, 40 - cumulativeHours); // Hours needed to reach 40
                                const hoursBeyond40 = entryHours - remainingHoursTo40; // Remaining hours beyond 40

                                // First row: Hours up to 40
                                if (remainingHoursTo40 > 0) {
                                    rowHTML = `
                                        <tr>
                                            <td>${entry.WorkDate}</td>
                                            <td>${entry.WSNumber} - ${entry.OpName}</td>
                                            <td>
                                                <select name="paychex_code_${entry.EntryID}_1" class="form-control">
                                                    ${payrollPaychex_list.map(paychex => `
                                                        <option value="${paychex.id}" ${paychex.code === 'E1' ? 'selected' : ''}>
                                                            ${paychex.code} - ${paychex.description}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </td>
                                            <td>${remainingHoursTo40.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }

                                // Second row: Overtime hours beyond 40 with E15 code
                                if (hoursBeyond40 > 0) {
                                    rowHTML += `
                                        <tr>
                                            <td>${entry.WorkDate}</td>
                                            <td>${entry.WSNumber} - ${entry.OpName}</td>
                                            <td>
                                                <select name="paychex_code_${entry.EntryID}_2" class="form-control">
                                                    ${payrollPaychex_list.map(paychex => `
                                                        <option value="${paychex.id}" ${paychex.code === 'E51' ? 'selected' : ''}>
                                                            ${paychex.code} - ${paychex.description}
                                                        </option>
                                                    `).join('')}
                                                </select>
                                            </td>
                                            <td>${hoursBeyond40.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                                totalHours += entryHours; // Add to total hours
                            } 
                            /* else {
                                // Entire entry is overtime
                                rowHTML = `
                                    <tr>
                                        <td>${entry.WorkDate}</td>
                                        <td>${entry.WSNumber} - ${entry.OpName}</td>
                                        <td>
                                            <select name="paychex_code_${entry.EntryID}" class="form-control">
                                                ${payrollPaychex_list.map(paychex => `
                                                    <option value="${paychex.id}" ${paychex.code === 'E51' ? 'selected' : ''}>
                                                        ${paychex.code} - ${paychex.description}
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </td>
                                        <td>${entryHours.toFixed(2)}</td>
                                    </tr>
                                `;
                                totalHours += entryHours; // Add to total hours
                            } */
                        }

                        cumulativeHours += parseFloat(entry.tHoursWorked);

                        totalHoursBadge.textContent = totalHours.toFixed(2); // Update the total hours badge

                        // Append the row to the table body
                        tableBody.insertAdjacentHTML('beforeend', rowHTML);

                        console.log("Cumulative Hours After:", cumulativeHours); // Debugging cumulative hours
                    });
                } else {
                    console.error('Error fetching time entries:', data.error);
                }
            })
            .catch(error => console.error('Error fetching time entries:', error));
    });

    document.getElementById('finalizeTimeForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent the default form submission
    
        // Gather data from the table
        const tableRows = document.querySelectorAll('#finalizeTimeModal tbody tr');
        const finalizeData = [];
        let totalHours = 0;
    
        tableRows.forEach(row => {
            const date = row.querySelector('td:nth-child(1)').textContent.trim();
            //const operation = row.querySelector('td:nth-child(2)').textContent.trim();
            const paychexCode = row.querySelector('td:nth-child(3) select').value;
            const hours = parseFloat(row.querySelector('td:nth-child(4)').textContent.trim());
    
            finalizeData.push({
                date: date,
                paychexCode: paychexCode,
                hours: hours
            });
    
            // Accumulate total hours
            totalHours += hours;
        });
    
        // Get the abas_id from the hidden input field
        const abasID = document.getElementById('abasIDInput').value;
        const startDate = document.getElementById('startDateInput').value;

        // Create the JSON payload
        const jsonData = JSON.stringify({
            abas_id: abasID,
            start_date: startDate,
            total_hours: totalHours.toFixed(2), // Include total hours
            time_entries: finalizeData
        });
    
        // Send the JSON data to the API server
        fetch('/timesheet/payroll_export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: jsonData,
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showSnackbar('Time data finalized successfully!', 'success');
                    // Disable the finalize button and Add Time button
                    document.getElementById('finalizeTimeModalButton').disabled = true;
                    document.getElementById('finalizeTimeButton').disabled = true;
                    document.getElementById('addTimeButton').disabled = true;


                    console.log('Closing modal...');
                    // Close the Finalize Time Modal
                    $('#finalizeTimeModal').modal('hide');

                    // Fallback: Force hide the modal if it doesn't close
                    const modalElement = document.getElementById('finalizeTimeModal');
                    if ($(modalElement).is(':visible')) {
                        console.log('Forcing modal to hide...');
                        modalElement.classList.remove('show');
                        modalElement.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        document.querySelector('.modal-backdrop').remove();
                    }
                                                          
                } else {
                    showSnackbar('Failed to finalize time data: ' + result.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error finalizing time data:', error);
                showSnackbar('An unexpected error occurred.', 'error');
            });
    });

    // Event listener for project selection
    document.getElementById('projectDropdown').addEventListener('change', function () {
        const selectedProjectId = this.value;

        if (selectedProjectId) {
            // Fetch work orders for the selected project
            fetch('/timesheet/entry/getWorkOrders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ projectId: selectedProjectId }),
            })
                .then(response => response.json())
                .then(data => {
                    const workOrderDropdown = document.getElementById('workOrderDropdown');
                    const workSlipDropdown = document.getElementById('workSlipDropdown');
                    workOrderDropdown.innerHTML = ''; // Clear existing options
                    workSlipDropdown.innerHTML = ''; // Clear existing options

                    if (data.workOrders && data.workOrders.length > 0) {
                        // Populate the dropdown with work orders
                        data.workOrders.forEach(workOrder => {
                            const option = document.createElement('option');
                            option.value = workOrder.id;
                            option.textContent = workOrder.id + " - " + workOrder.part + " - " + workOrder.desc;
                            workOrderDropdown.appendChild(option);
                        });

                        // Show the dropdown and refresh Bootstrap Select
                        workOrderDropdown.style.display = 'block';
                        $('.selectpicker').selectpicker('refresh');
                    } else {
                        // Hide the dropdown if no work orders are available
                        workOrderDropdown.style.display = 'none';
                    }
                })
                .catch(error => console.error('Error fetching work orders:', error));
        }
    });

    // Event listener for work order selection
    document.getElementById('workOrderDropdown').addEventListener('change', function () {
        const selectedWorkOrderId = this.value;

        if (selectedWorkOrderId) {
            // Fetch workslips for the selected work order
            fetch('/timesheet/entry/getWorkSlips', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ workOrderId: selectedWorkOrderId }),
            })
                .then(response => response.json())
                .then(data => {
                    const workSlipDropdown = document.getElementById('workSlipDropdown');
                    workSlipDropdown.innerHTML = ''; // Clear existing options

                    if (data.workSlips && data.workSlips.length > 0) {
                        // Populate the dropdown with workslips
                        data.workSlips.forEach(workSlip => {
                            const option = document.createElement('option');
                            option.value = workSlip.id;
                            option.textContent = workSlip.id + " - " + workSlip.nameExtended + " (" + workSlip.name + ")";
                            workSlipDropdown.appendChild(option);
                        });

                        // Show the dropdown and refresh Bootstrap Select
                        workSlipDropdown.style.display = 'block';
                        $('.selectpicker').selectpicker('refresh');
                    } else {
                        // Hide the dropdown if no workslips are available
                        workSlipDropdown.style.display = 'none';
                    }
                })
                .catch(error => console.error('Error fetching workslips:', error));
        }
    });

    // Event listener for workslip selection
    document.getElementById('workSlipDropdown').addEventListener('change', function () {
        const selectedWorkSlipId = this.value;

        if (selectedWorkSlipId) {
            // Populate the hidden field with the selected workslip ID
            document.getElementById('workSlipIDInput').value = selectedWorkSlipId;

            // Log the selected workslip ID (optional)
            console.log('Selected Work Slip ID:', selectedWorkSlipId);
        }
    });

    // Event listener for date card selection
    // Select the first date card by default (current day)
    document.querySelectorAll('.select-date-card').forEach(card => {
        card.addEventListener('click', function () {
            // Deselect all cards
            document.querySelectorAll('.select-date-card').forEach(item => {
                item.classList.remove('bg-success', 'text-white'); // Remove selected style
                item.setAttribute('data-selected', 'false'); // Mark as not selected
            });

            // Select the clicked card
            this.classList.add('bg-success', 'text-white'); // Highlight the selected card
            this.setAttribute('data-selected', 'true'); // Mark as selected

            // Log the selected date (optional)
            console.log('Selected date:', this.getAttribute('data-date'));

            // Example: Update a hidden input field with the selected date
            document.getElementById('selectedDateInput').value = this.getAttribute('data-date');
        });
    });

    // Set the hidden input field to the preselected date (current day)
    const preselectedCard = document.querySelector('.select-date-card[data-selected="true"]');
    if (preselectedCard) {
        document.getElementById('selectedDateInput').value = preselectedCard.getAttribute('data-date');
    }

    // Event listener for time entry deletion
    document.addEventListener('DOMContentLoaded', function () {
        // Add event listener to all delete buttons
        document.querySelectorAll('.delete-entry-btn').forEach(button => {
            button.addEventListener('click', function () {
                const timeEntryID = this.getAttribute('data-timeentryid');

                if (confirm('Are you sure you want to delete this time entry?')) {
                    // Send a request to delete the time entry
                    fetch(`/timesheet/entry/delete/${timeEntryID}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: timeEntryID }),
                    })
                        .then(response => {
                            if (response.ok) {
                                // Remove the time entry from the UI
                                const timeEntryElement = this.closest('.time-entry');
                                const cardBody = timeEntryElement.closest('.card-body');
                                const cardFooter = cardBody.nextElementSibling; // Assuming footer is the next sibling
                                const totalHoursElement = cardFooter.querySelector('.font-weight-bold');

                                // Get the hours of the deleted entry
                                const deletedHours = parseFloat(
                                    timeEntryElement.querySelector('.badge').textContent
                                );

                                // Remove the time entry from the UI
                                timeEntryElement.remove();

                                // Update the total hours in the card footer
                                const currentTotal = parseFloat(totalHoursElement.textContent) || 0;
                                const newTotal = currentTotal - deletedHours;
                                totalHoursElement.textContent = newTotal.toFixed(2);

                                // Recalculate the total hours for the floating badge
                                updateTotalHours();

                                // Check if the card is now empty
                                if (cardBody.querySelectorAll('.time-entry').length === 0) {
                                    // Add a "No data available" message
                                    const noDataMessage = document.createElement('p');
                                    noDataMessage.textContent = 'No data available for this date.';
                                    cardBody.appendChild(noDataMessage);
                                }
                                showSnackbar('Time entry deleted successfully!', 'success');
                            } else {
                                showSnackbar('Failed to delete time entry.', 'error');
                            }
                        })
                        .catch(error => console.error('Error deleting time entry:', error));
                }
            });
        });
    });

    // Function to attach delete event to dynamically created buttons
    function attachDeleteEvent(button) {
        button.addEventListener('click', function () {
            const timeEntryID = this.getAttribute('data-timeentryid');

            if (confirm('Are you sure you want to delete this time entry?')) {
                fetch(`/timesheet/entry/delete/${timeEntryID}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: timeEntryID }),
                })
                    .then(response => {
                        if (response.ok) {
                            const timeEntryElement = this.closest('.time-entry');
                            const cardBody = timeEntryElement.closest('.card-body');
                            const cardFooter = cardBody.nextElementSibling; // Assuming footer is the next sibling
                            const totalHoursElement = cardFooter.querySelector('.font-weight-bold');

                            // Get the hours of the deleted entry
                            const deletedHours = parseFloat(
                                timeEntryElement.querySelector('.badge').textContent
                            );

                            // Remove the time entry from the UI
                            timeEntryElement.remove();

                            // Update the total hours in the card footer
                            const currentTotal = parseFloat(totalHoursElement.textContent) || 0;
                            const newTotal = currentTotal - deletedHours;
                            totalHoursElement.textContent = newTotal.toFixed(2);

                            // Recalculate the total hours for the floating badge
                            updateTotalHours();

                            // Check if the card is now empty
                            if (cardBody.querySelectorAll('.time-entry').length === 0) {
                                // Add a "No data available" message
                                const noDataMessage = document.createElement('p');
                                noDataMessage.textContent = 'No data available for this date.';
                                cardBody.appendChild(noDataMessage);
                            }
                            showSnackbar('Time entry deleted successfully!');
                        } else {
                            showSnackbar('Failed to delete time entry.', 'error');
                        }
                    })
                    .catch(error => console.error('Error deleting time entry:', error));
            }
        });
    }

    // Event listener for form submission
    document.getElementById('dateForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent the default form submission

        // Gather form data
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        // Send the data to the server
        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update the UI with the new time entry
                    const cardBody = document.querySelector(`#card_${data.selectedDate.replace(/\//g, '_')} .card-body`);

                    // Remove "No data available" message if it exists
                    const noDataMessage = cardBody.querySelector('p');
                    if (noDataMessage && noDataMessage.textContent === 'No data available for this date.') {
                        noDataMessage.remove();
                    }

                    // Add the new time entry to the card
                    const timeEntryDiv = document.createElement('div');
                    timeEntryDiv.classList.add('d-flex', 'justify-content-between', 'align-items-center', 'time-entry');
                    timeEntryDiv.innerHTML = `
                        <p>${result.data.WSNumber} ${result.data.OpNameExtended}</p>
                        <h5><span class="badge badge-secondary">${result.data.tHoursWorked}</span></h5>
                        <button class="btn btn-danger btn-sm delete-entry-btn" data-timeentryid="${result.data.TimeEntryID}" title="Delete Entry">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    cardBody.appendChild(timeEntryDiv);

                    // Update the total hours in the card footer
                    const cardFooter = cardBody.nextElementSibling; // Assuming footer is the next sibling
                    const totalHoursElement = cardFooter.querySelector('.font-weight-bold');
                    const currentTotal = parseFloat(totalHoursElement.textContent) || 0;
                    const newTotal = currentTotal + parseFloat(result.data.tHoursWorked);
                    totalHoursElement.textContent = newTotal.toFixed(2);

                    // Recalculate the total hours for the floating badge
                    updateTotalHours();

                    // Reattach the delete button event listener
                    attachDeleteEvent(timeEntryDiv.querySelector('.delete-entry-btn'));

                    // Close the modal
                    // const addTimeModal = bootstrap.Modal.getInstance(document.getElementById('addTimeModal'));
                    // addTimeModal.hide();

                    // alert('Time entry added successfully.');
                    showSnackbar('Time entry added successfully!', 'success');
                } else {
                    //alert('Failed to add time entry: ' + result.error);
                    showSnackbar(result.error, 'error');
                }
            })
            .catch(error => console.error('Error adding time entry:', error));
    });

</script>
{% endblock %}